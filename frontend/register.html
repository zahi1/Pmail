<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pmail - Register</title>
    <link rel="icon" type="image/png" href="../public/images/Pmail1.png" />
    <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>

    <div class="register-container">
        <img src="/public/images/Pmail1.png" alt="Pmail Logo">
        <h2>Create a Pmail Account</h2>

        <!-- Hidden input for role selection -->
        <input type="hidden" id="role">

        <!-- Step 1: Name -->
        <div id="step-1" class="form-step">
            <input type="text" id="first_name" placeholder="First name" required>
            <input type="text" id="last_name" placeholder="Last name" required>
            <p id="name-error" class="error-message" style="display: none; color: red;">
              Please enter both first and last name.
            </p>
            <button onclick="validateName()">Next</button>
        </div>

        <!-- Step 2: Birthdate Validation -->
        <div id="step-2" class="form-step" style="display: none;">
            <label>Birthdate:</label>
            <input type="date" id="birthdate" required>
            <p id="age-error" class="error-message" style="display: none; color: red;">
              You must be at least 13 years old to register.
            </p>
            <button onclick="validateBirthdate()">Next</button>
        </div>

        <!-- Step 3: Choose Email -->
        <div id="step-3" class="form-step" style="display: none;">
            <h3>Choose your Pmail address</h3>
            <p>Pick a Pmail address or create your own:</p>
            
            <input type="radio" id="email_option1" name="email_option" value="user123@pmail.com" onclick="checkSelectedEmail('user123@pmail.com')">
            <label for="email_option1">user123@pmail.com</label><br>
            
            <input type="radio" id="email_option2" name="email_option" value="jobseeker@pmail.com" onclick="checkSelectedEmail('jobseeker@pmail.com')">
            <label for="email_option2">jobseeker@pmail.com</label><br>
            
            <input type="radio" id="custom_email_option" name="email_option" onclick="enableCustomEmail()">
            <input type="email" id="email_input" placeholder="Create your own Pmail address" disabled required>
        
            <p id="email-error" class="error-message" style="display: none; color: red;">
              Email must end with @pmail.com.
            </p>
            <div id="email-checking" style="display: none;">Checking availability...</div>
            <button id="email-next-btn" onclick="validateEmail()">Next</button>
        </div>

        <!-- Step 4: Password Setup -->
        <div id="step-4" class="form-step" style="display: none;">
            <input type="password" id="password" placeholder="Password" required>
            <input type="password" id="confirm_password" placeholder="Confirm Password" required>
            <input type="checkbox" onclick="togglePassword()"> Show Password
            <p id="password-error" class="error-message" style="display: none; color: red;">
              Passwords do not match.
            </p>
            <button onclick="validatePassword()">Next</button>
        </div>

        <!-- Step 5: Phone Number & Final Sign Up -->
        <div id="step-5" class="form-step" style="display: none;">
            <input type="tel" id="phone" placeholder="Phone Number" required>
            <p id="phone-error" class="error-message" style="display: none; color: red;">
              Please enter a valid phone number.
            </p>
            <div id="phone-checking" style="display: none;">Checking availability...</div>
            
            <!-- Categories field - for employees only -->
            <div class="form-group employee-field" id="categories-group" style="display:none;">
              <label>Job Categories of Interest</label>
              <div class="categories-container" id="registration-categories-container">
                <div class="category-item" data-value="Arts">Arts</div>
                <div class="category-item" data-value="Business">Business</div>
                <div class="category-item" data-value="Communications">Communications</div>
                <div class="category-item" data-value="Education">Education</div>
                <div class="category-item" data-value="Healthcare">Healthcare</div>
                <div class="category-item" data-value="Hospitality">Hospitality</div>
                <div class="category-item" data-value="Information Technology">Information Technology</div>
                <div class="category-item" data-value="Law Enforcement">Law Enforcement</div>
                <div class="category-item" data-value="Sales and Marketing">Sales and Marketing</div>
                <div class="category-item" data-value="Science">Science</div>
                <div class="category-item" data-value="Transportation">Transportation</div>
              </div>
              <input type="hidden" id="user_categories" name="user_categories" />
              <p id="categories-error" class="error-message" style="display: none; color: red;">
                Please select at least one category.
              </p>
            </div>
            
            <!-- The external JS (auth.js) will handle the click event for register-btn -->
            <button type="button" id="register-btn" onclick="validateFinal()">Sign Up</button>
        </div>
    </div>

    <!-- External script for login & register calls -->
    <script src="/public/js/auth.js"></script>

    <!-- Inline script for multi-step logic ONLY -->
    <script>
        // 1) On page load, check the URL for a valid role (employee/employer)
        function getRoleFromURL() {
            const params = new URLSearchParams(window.location.search);
            let role = params.get("role");
            if (!role || (role !== "employee" && role !== "employer")) {
                alert("Invalid role. Redirecting...");
                window.location.href = "login.html"; 
            }
            document.getElementById("role").value = role;
        }
        document.addEventListener("DOMContentLoaded", getRoleFromURL);

        // 2) nextStep: hides the current step, shows the next
        function nextStep(step) {
            document.getElementById("step-" + step).style.display = "none";
            document.getElementById("step-" + (step + 1)).style.display = "block";
        }

        // 3) Enable custom email input if user selects that radio
        function enableCustomEmail() {
            let emailInput = document.getElementById("email_input");
            emailInput.disabled = false;
            emailInput.focus();
            
            // Add input event listener for custom email checking
            emailInput.addEventListener("input", function() {
                let email = this.value.trim();
                if (!email || !/^[a-zA-Z0-9._%+-]+@pmail\.com$/.test(email)) return;
                
                let emailError = document.getElementById("email-error");
                let emailChecking = document.getElementById("email-checking");
                
                emailChecking.style.display = "block";
                emailError.style.display = "none";
                
                debouncedCheckEmail(email, function(result) {
                    emailChecking.style.display = "none";
                    if (result.error) {
                        emailError.textContent = "Error checking email.";
                        emailError.style.display = "block";
                    } else if (!result.available) {
                        emailError.textContent = "This email address is already in use.";
                        emailError.style.display = "block";
                    } else {
                        emailError.style.display = "none";
                    }
                });
            });
        }

        // 4) Toggle password fields from type=password to text
        function togglePassword() {
            let password = document.getElementById("password");
            let confirmPassword = document.getElementById("confirm_password");
            password.type = (password.type === "password") ? "text" : "password";
            confirmPassword.type = (confirmPassword.type === "password") ? "text" : "password";
        }

        // 5) Validate birthdate (13+ years old)
        function validateBirthdate() {
            let birthdate = document.getElementById("birthdate").value;
            if (!birthdate) {
                document.getElementById("age-error").textContent = "Please enter your birthdate.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            let birthDateObj = new Date(birthdate);
            let today = new Date();
            
            // Calculate age
            let age = today.getFullYear() - birthDateObj.getFullYear();
            let monthDiff = today.getMonth() - birthDateObj.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDateObj.getDate())) {
                age--;
            }
            
            // Check minimum age (13)
            if (age < 13) {
                document.getElementById("age-error").textContent = "You must be at least 13 years old to register.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            // Check maximum age (122)
            if (age > 122) {
                document.getElementById("age-error").textContent = "Maximum age cannot exceed 122 years.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            document.getElementById("age-error").style.display = "none";
            nextStep(2);
        }

        // 6) Validate email radio choice or custom input
        async function validateEmail() {
            let selectedEmailOption = document.querySelector('input[name="email_option"]:checked');
            let customEmailInput   = document.getElementById("email_input");
            let emailError         = document.getElementById("email-error");
            let emailChecking      = document.getElementById("email-checking");
            let emailNextBtn       = document.getElementById("email-next-btn");
            
            let email = "";

            // If user picked a standard radio option (not custom)
            if (selectedEmailOption && selectedEmailOption.id !== "custom_email_option") {
                email = selectedEmailOption.value;
            }
            // Else if user typed a custom email
            else if (customEmailInput && !customEmailInput.disabled) {
                email = customEmailInput.value.trim();
            }

            // Must end with @pmail.com
            let emailPattern = /^[a-zA-Z0-9._%+-]+@pmail\.com$/;

            if (email === "") {
                emailError.textContent = "Please select or enter a Pmail address.";
                emailError.style.display = "block";
                return;
            } else if (!emailPattern.test(email)) {
                emailError.textContent = "Email must end with @pmail.com.";
                emailError.style.display = "block";
                return;
            }
            
            // Disable next button while checking
            emailNextBtn.disabled = true;
            
            // Show loading indicator
            emailChecking.style.display = "block";
            emailError.style.display = "none";
            
            try {
                const result = await checkEmailAvailability(email);
                
                emailChecking.style.display = "none";
                
                if (result.error) {
                    emailError.textContent = "Error checking email. Please try again.";
                    emailError.style.display = "block";
                    emailNextBtn.disabled = false;
                    return;
                }
                
                if (!result.available) {
                    emailError.textContent = "This email address is already in use.";
                    emailError.style.display = "block";
                    emailNextBtn.disabled = false;
                    return;
                }
                
                // Email is available
                emailError.style.display = "none";
                emailNextBtn.disabled = false;
                nextStep(3);
            } catch (error) {
                emailChecking.style.display = "none";
                emailError.textContent = "Error checking email. Please try again.";
                emailError.style.display = "block";
                emailNextBtn.disabled = false;
            }
        }
        
        // Check email as soon as it's selected via radio buttons
        function checkSelectedEmail(email) {
            let emailError = document.getElementById("email-error");
            let emailChecking = document.getElementById("email-checking");
            
            emailChecking.style.display = "block";
            emailError.style.display = "none";
            
            debouncedCheckEmail(email, function(result) {
                emailChecking.style.display = "none";
                if (result.error) {
                    emailError.textContent = "Error checking email.";
                    emailError.style.display = "block";
                } else if (!result.available) {
                    emailError.textContent = "This email address is already in use.";
                    emailError.style.display = "block";
                } else {
                    emailError.style.display = "none";
                }
            });
        }

        // 7) Validate password match
        function validatePassword() {
            let password        = document.getElementById("password").value;
            let confirmPassword = document.getElementById("confirm_password").value;
            let passwordError   = document.getElementById("password-error");

            // Check for password match
            if (password !== confirmPassword) {
                passwordError.textContent = "Passwords do not match.";
                passwordError.style.display = "block";
                return;
            }
            
            // Check for minimum length
            if (password.length < 8) {
                passwordError.textContent = "Password must be at least 8 characters long.";
                passwordError.style.display = "block";
                return;
            }
            
            // Check for uppercase letter
            if (!/[A-Z]/.test(password)) {
                passwordError.textContent = "Password must include at least one uppercase letter.";
                passwordError.style.display = "block";
                return;
            }
            
            // Check for special character
            if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                passwordError.textContent = "Password must include at least one special character.";
                passwordError.style.display = "block";
                return;
            }

            passwordError.style.display = "none";
            nextStep(4);
        }
        
        // Final validation before registration (Step 5)
        async function validateFinal() {
            let phone = document.getElementById("phone").value.trim();
            let phoneError = document.getElementById("phone-error");
            let phoneChecking = document.getElementById("phone-checking");
            let role = document.getElementById("role").value;
            let registerBtn = document.getElementById("register-btn");
            
            // Validate phone number
            let phonePattern = /^[0-9()+\-\s]{7,20}$/;
            if (!phone) {
                phoneError.textContent = "Please enter your phone number.";
                phoneError.style.display = "block";
                return;
            } else if (!phonePattern.test(phone)) {
                phoneError.textContent = "Please enter a valid phone number.";
                phoneError.style.display = "block";
                return;
            }
            
            // Disable button while checking
            registerBtn.disabled = true;
            
            // Show loading indicator
            phoneChecking.style.display = "block";
            phoneError.style.display = "none";
            
            try {
                const result = await checkPhoneAvailability(phone);
                
                phoneChecking.style.display = "none";
                
                if (result.error) {
                    phoneError.textContent = "Error checking phone number. Please try again.";
                    phoneError.style.display = "block";
                    registerBtn.disabled = false;
                    return;
                }
                
                if (!result.available) {
                    phoneError.textContent = "This phone number is already in use.";
                    phoneError.style.display = "block";
                    registerBtn.disabled = false;
                    return;
                }
                
                // For employees, validate categories
                if (role === "employee") {
                    let categories = document.getElementById("user_categories").value;
                    let categoriesError = document.getElementById("categories-error");
                    
                    if (!categories) {
                        categoriesError.textContent = "Please select at least one category.";
                        categoriesError.style.display = "block";
                        registerBtn.disabled = false;
                        return;
                    } else {
                        categoriesError.style.display = "none";
                    }
                }
                
                // If all validations pass, directly call the register function
                console.log("All validations passed, calling register()");
                registerUser(); // Use the renamed function to avoid conflict with the element id
                
            } catch (error) {
                console.error("Error in validateFinal:", error);
                phoneChecking.style.display = "none";
                phoneError.textContent = "Error checking phone number. Please try again.";
                phoneError.style.display = "block";
                registerBtn.disabled = false;
            }
        }

        // Renamed register function to avoid conflict with button id
        function registerUser() {
            console.log("Starting registration process");
            
            const firstName = document.getElementById("first_name").value.trim();
            const lastName = document.getElementById("last_name").value.trim();
            const birthdate = document.getElementById("birthdate").value;
            const password = document.getElementById("password").value;
            const phone = document.getElementById("phone").value.trim();
            const role = document.getElementById("role").value;
            const emailElem = document.querySelector('input[name="email_option"]:checked');
            const email = emailElem
              ? (emailElem.id === "custom_email_option"
                 ? document.getElementById("email_input").value.trim().toLowerCase()
                 : emailElem.value.trim().toLowerCase())
              : "";
              
            console.log("Preparing registration data:", { email, role, phone });
            
            const userData = {
                first_name: firstName,
                last_name: lastName,
                birthdate: birthdate,
                email: email,
                password: password,
                phone: phone,
                role: role,
                user_categories: role === "employee"
                  ? document.getElementById('user_categories').value
                  : undefined
            };

            // Show a loading message
            const registerBtn = document.getElementById("register-btn");
            registerBtn.textContent = "Registering...";
            
            fetch("/auth/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(userData)
            })
            .then(response => {
                console.log("Registration response:", response);
                return response.json();
            })
            .then(data => {
                console.log("Registration result:", data);
                const step5 = document.getElementById("step-5");
                
                // Success
                if (data.message === "User registered successfully") {
                    // insert or update success paragraph
                    let successEl = document.getElementById("register-success");
                    if (!successEl) {
                        successEl = document.createElement("p");
                        successEl.id = "register-success";
                        successEl.className = "success-message";
                        successEl.style.color = "green";
                        step5.insertBefore(successEl, step5.firstChild);
                    }
                    successEl.textContent = data.message + " Redirecting...";
                    
                    // delay then redirect
                    setTimeout(() => {
                        window.location.href = role === "employee"
                          ? "/frontend/employee_inbox.html"
                          : "/frontend/employer_inbox.html";
                    }, 1500);
                }
                // Error
                else {
                    // show server error inline at bottom of form
                    let serverError = document.getElementById("register-server-error");
                    if (!serverError) {
                        serverError = document.createElement("p");
                        serverError.id = "register-server-error";
                        serverError.className = "error-message";
                        serverError.style.color = "red";
                        step5.insertBefore(serverError, step5.firstChild);
                    }
                    serverError.textContent = data.error || "Registration failed";
                    serverError.style.display = "block";
                    registerBtn.textContent = "Sign Up";
                    registerBtn.disabled = false;
                }
            })
            .catch(err => {
                console.error("Registration error:", err);
                let networkError = document.getElementById("register-server-error");
                if (!networkError) {
                    networkError = document.createElement("p");
                    networkError.id = "register-server-error";
                    networkError.className = "error-message";
                    networkError.style.color = "red";
                    const step5 = document.getElementById("step-5");
                    step5.insertBefore(networkError, step5.firstChild);
                }
                networkError.textContent = "Network error, please try again";
                networkError.style.display = "block";
                registerBtn.textContent = "Sign Up";
                registerBtn.disabled = false;
            });
        }

        // Setup phone number validation on input
        document.addEventListener("DOMContentLoaded", function() {
            const phoneInput = document.getElementById("phone");
            if (phoneInput) {
                phoneInput.addEventListener("input", function() {
                    let phone = this.value.trim();
                    if (!phone || phone.length < 7) return;
                    
                    let phoneError = document.getElementById("phone-error");
                    let phoneChecking = document.getElementById("phone-checking");
                    
                    phoneChecking.style.display = "block";
                    phoneError.style.display = "none";
                    
                    debouncedCheckPhone(phone, function(result) {
                        phoneChecking.style.display = "none";
                        if (result.error) {
                            phoneError.textContent = "Error checking phone number.";
                            phoneError.style.display = "block";
                        } else if (!result.available) {
                            phoneError.textContent = "This phone number is already in use.";
                            phoneError.style.display = "block";
                        } else {
                            phoneError.style.display = "none";
                        }
                    });
                });
            }
        });

        // New validation for first and last name (Step 1)
        function validateName() {
            let firstName = document.getElementById("first_name").value.trim();
            let lastName = document.getElementById("last_name").value.trim();
            let nameError = document.getElementById("name-error");

            if (!firstName || !lastName) {
                nameError.textContent = "Please enter both first and last name.";
                nameError.style.display = "block";
            } else {
                nameError.style.display = "none";
                nextStep(1);
            }
        }
    </script>
</body>
</html>
