<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pmail - Register</title>
    <link rel="icon" type="image/png" href="../public/images/Pmail1.png" />
    <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>

    <div class="register-container">
        <img src="/public/images/Pmail1.png" alt="Pmail Logo">
        <h2>Create a Pmail Account</h2>

        <input type="hidden" id="role">

        <div id="step-1" class="form-step">
            <input type="text" id="first_name" placeholder="First name" required>
            <input type="text" id="last_name" placeholder="Last name" required>
            <p id="name-error" class="error-message" style="display: none; color: red;">
              Please enter both first and last name.
            </p>
            <button onclick="validateName()">Next</button>
        </div>

        <div id="step-2" class="form-step" style="display: none;">
            <label>Birthdate:</label>
            <input type="date" id="birthdate" required>
            <p id="age-error" class="error-message" style="display: none; color: red;">
              You must be at least 13 years old to register.
            </p>
            <button onclick="validateBirthdate()">Next</button>
        </div>

        <div id="step-3" class="form-step" style="display: none;">
           
            <input type="email" id="email_input" placeholder="Enter your Pmail address" required>
            <p id="email-error" class="error-message" style="display: none; color: red;">
              Email must end with @pmail.com.
            </p>
            <div id="email-checking" style="display: none;">Checking availability...</div>
            <button id="email-next-btn" onclick="validateEmail()">Next</button>
        </div>

        <div id="step-4" class="form-step" style="display: none;">
            <input type="password" id="password" placeholder="Password" required>
            <input type="password" id="confirm_password" placeholder="Confirm Password" required>
            <input type="checkbox" onclick="togglePassword()"> Show Password
            <p id="password-error" class="error-message" style="display: none; color: red;">
              Passwords do not match.
            </p>
            <button onclick="validatePassword()">Next</button>
        </div>

        <div id="step-5" class="form-step" style="display: none;">
            <input type="tel" id="phone" placeholder="Phone Number" required>
            <p id="phone-error" class="error-message" style="display: none; color: red;">
              Please enter a valid phone number.
            </p>
            <div id="phone-checking" style="display: none;">Checking availability...</div>
            
            <div class="form-group employee-field" id="categories-group" style="display:none;">
              <label>Job Categories of Interest</label>
              <div class="categories-container" id="registration-categories-container">
                <div class="category-item" data-value="Arts">Arts</div>
                <div class="category-item" data-value="Business">Business</div>
                <div class="category-item" data-value="Communications">Communications</div>
                <div class="category-item" data-value="Education">Education</div>
                <div class="category-item" data-value="Healthcare">Healthcare</div>
                <div class="category-item" data-value="Hospitality">Hospitality</div>
                <div class="category-item" data-value="Information Technology">Information Technology</div>
                <div class="category-item" data-value="Law Enforcement">Law Enforcement</div>
                <div class="category-item" data-value="Sales and Marketing">Sales and Marketing</div>
                <div class="category-item" data-value="Science">Science</div>
                <div class="category-item" data-value="Transportation">Transportation</div>
              </div>
              <input type="hidden" id="user_categories" name="user_categories" />
              <p id="categories-error" class="error-message" style="display: none; color: red;">
                Please select at least one category.
              </p>
            </div>
            
            <button type="button" id="register-btn" onclick="validateFinal()">Sign Up</button>
        </div>
    </div>

    <script src="/public/js/auth.js"></script>

    <script>
        function getRoleFromURL() {
            const params = new URLSearchParams(window.location.search);
            let role = params.get("role");
            if (!role || (role !== "employee" && role !== "employer")) {
                alert("Invalid role. Redirecting...");
                window.location.href = "login.html"; 
            }
            document.getElementById("role").value = role;
        }
        document.addEventListener("DOMContentLoaded", getRoleFromURL);

        function nextStep(step) {
            document.getElementById("step-" + step).style.display = "none";
            document.getElementById("step-" + (step + 1)).style.display = "block";
        }

        function togglePassword() {
            let password = document.getElementById("password");
            let confirmPassword = document.getElementById("confirm_password");
            password.type = (password.type === "password") ? "text" : "password";
            confirmPassword.type = (confirmPassword.type === "password") ? "text" : "password";
        }

        function validateBirthdate() {
            let birthdate = document.getElementById("birthdate").value;
            if (!birthdate) {
                document.getElementById("age-error").textContent = "Please enter your birthdate.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            let birthDateObj = new Date(birthdate);
            let today = new Date();
            
            let age = today.getFullYear() - birthDateObj.getFullYear();
            let monthDiff = today.getMonth() - birthDateObj.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDateObj.getDate())) {
                age--;
            }
            
            if (age < 13) {
                document.getElementById("age-error").textContent = "You must be at least 13 years old to register.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            if (age > 122) {
                document.getElementById("age-error").textContent = "Maximum age cannot exceed 122 years.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            document.getElementById("age-error").style.display = "none";
            nextStep(2);
        }

        async function validateEmail() {
            let customEmailInput = document.getElementById("email_input");
            let emailError = document.getElementById("email-error");
            let emailChecking = document.getElementById("email-checking");
            let emailNextBtn = document.getElementById("email-next-btn");
            
            let email = customEmailInput.value.trim();

            let emailPattern = /^[a-zA-Z0-9._%+-]+@pmail\.com$/;

            if (email === "") {
                emailError.textContent = "Please enter a Pmail address.";
                emailError.style.display = "block";
                return;
            } else if (!emailPattern.test(email)) {
                emailError.textContent = "Email must end with @pmail.com.";
                emailError.style.display = "block";
                return;
            }
            
            emailNextBtn.disabled = true;
            
            emailChecking.style.display = "block";
            emailError.style.display = "none";
            
            try {
                const result = await checkEmailAvailability(email);
                
                emailChecking.style.display = "none";
                
                if (result.error) {
                    emailError.textContent = "Error checking email. Please try again.";
                    emailError.style.display = "block";
                    emailNextBtn.disabled = false;
                    return;
                }
                
                if (!result.available) {
                    emailError.textContent = "This email address is already in use.";
                    emailError.style.display = "block";
                    emailNextBtn.disabled = false;
                    return;
                }
                
                emailError.style.display = "none";
                emailNextBtn.disabled = false;
                nextStep(3);
            } catch (error) {
                emailChecking.style.display = "none";
                emailError.textContent = "Error checking email. Please try again.";
                emailError.style.display = "block";
                emailNextBtn.disabled = false;
            }
        }

        function validatePassword() {
            let password        = document.getElementById("password").value;
            let confirmPassword = document.getElementById("confirm_password").value;
            let passwordError   = document.getElementById("password-error");

            if (password !== confirmPassword) {
                passwordError.textContent = "Passwords do not match.";
                passwordError.style.display = "block";
                return;
            }
            
            if (password.length < 8) {
                passwordError.textContent = "Password must be at least 8 characters long.";
                passwordError.style.display = "block";
                return;
            }
            
            if (!/[A-Z]/.test(password)) {
                passwordError.textContent = "Password must include at least one uppercase letter.";
                passwordError.style.display = "block";
                return;
            }
            
            if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                passwordError.textContent = "Password must include at least one special character.";
                passwordError.style.display = "block";
                return;
            }

            passwordError.style.display = "none";
            nextStep(4);
        }
        
        async function validateFinal() {
            let phone = document.getElementById("phone").value.trim();
            let phoneError = document.getElementById("phone-error");
            let phoneChecking = document.getElementById("phone-checking");
            let role = document.getElementById("role").value;
            let registerBtn = document.getElementById("register-btn");
            
            let phonePattern = /^[0-9()+\-\s]{7,20}$/;
            if (!phone) {
                phoneError.textContent = "Please enter your phone number.";
                phoneError.style.display = "block";
                return;
            } else if (!phonePattern.test(phone)) {
                phoneError.textContent = "Please enter a valid phone number.";
                phoneError.style.display = "block";
                return;
            }
            
            registerBtn.disabled = true;
            
            phoneChecking.style.display = "block";
            phoneError.style.display = "none";
            
            try {
                const result = await checkPhoneAvailability(phone);
                
                phoneChecking.style.display = "none";
                
                if (result.error) {
                    phoneError.textContent = "Error checking phone number. Please try again.";
                    phoneError.style.display = "block";
                    registerBtn.disabled = false;
                    return;
                }
                
                if (!result.available) {
                    phoneError.textContent = "This phone number is already in use.";
                    phoneError.style.display = "block";
                    registerBtn.disabled = false;
                    return;
                }
                
                if (role === "employee") {
                    let categories = document.getElementById("user_categories").value;
                    let categoriesError = document.getElementById("categories-error");
                    
                    if (!categories) {
                        categoriesError.textContent = "Please select at least one category.";
                        categoriesError.style.display = "block";
                        registerBtn.disabled = false;
                        return;
                    } else {
                        categoriesError.style.display = "none";
                    }
                }
                
                console.log("All validations passed, calling register()");
                registerUser();
                
            } catch (error) {
                console.error("Error in validateFinal:", error);
                phoneChecking.style.display = "none";
                phoneError.textContent = "Error checking phone number. Please try again.";
                phoneError.style.display = "block";
                registerBtn.disabled = false;
            }
        }


        function registerUser() {
            console.log("Starting registration process");
            
            const firstName = document.getElementById("first_name").value.trim();
            const lastName = document.getElementById("last_name").value.trim();
            const birthdate = document.getElementById("birthdate").value;
            const password = document.getElementById("password").value;
            const phone = document.getElementById("phone").value.trim();
            const role = document.getElementById("role").value;
            const email = document.getElementById("email_input").value.trim().toLowerCase();
            
            console.log("Preparing registration data:", { email, role, phone });
            
            const userData = {
                first_name: firstName,
                last_name: lastName,
                birthdate: birthdate,
                email: email,
                password: password,
                phone: phone,
                role: role,
                user_categories: role === "employee"
                  ? document.getElementById('user_categories').value
                  : undefined
            };

            const registerBtn = document.getElementById("register-btn");
            registerBtn.textContent = "Registering...";
            
            fetch("/auth/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(userData)
            })
            .then(response => {
                console.log("Registration response:", response);
                return response.json();
            })
            .then(data => {
                console.log("Registration result:", data);
                const step5 = document.getElementById("step-5");
                
                if (data.message === "User registered successfully") {
                    let successEl = document.getElementById("register-success");
                    if (!successEl) {
                        successEl = document.createElement("p");
                        successEl.id = "register-success";
                        successEl.className = "success-message";
                        successEl.style.color = "green";
                        step5.insertBefore(successEl, step5.firstChild);
                    }
                    successEl.textContent = data.message + " Redirecting...";
                    
                    setTimeout(() => {
                        window.location.href = role === "employee"
                          ? "/frontend/employee_inbox.html"
                          : "/frontend/employer_inbox.html";
                    }, 1500);
                }
                else {
                    let serverError = document.getElementById("register-server-error");
                    if (!serverError) {
                        serverError = document.createElement("p");
                        serverError.id = "register-server-error";
                        serverError.className = "error-message";
                        serverError.style.color = "red";
                        step5.insertBefore(serverError, step5.firstChild);
                    }
                    serverError.textContent = data.error || "Registration failed";
                    serverError.style.display = "block";
                    registerBtn.textContent = "Sign Up";
                    registerBtn.disabled = false;
                }
            })
            .catch(err => {
                console.error("Registration error:", err);
                let networkError = document.getElementById("register-server-error");
                if (!networkError) {
                    networkError = document.createElement("p");
                    networkError.id = "register-server-error";
                    networkError.className = "error-message";
                    networkError.style.color = "red";
                    const step5 = document.getElementById("step-5");
                    step5.insertBefore(networkError, step5.firstChild);
                }
                networkError.textContent = "Network error, please try again";
                networkError.style.display = "block";
                registerBtn.textContent = "Sign Up";
                registerBtn.disabled = false;
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            const phoneInput = document.getElementById("phone");
            if (phoneInput) {
                phoneInput.addEventListener("input", function() {
                    let phone = this.value.trim();
                    if (!phone || phone.length < 7) return;
                    
                    let phoneError = document.getElementById("phone-error");
                    let phoneChecking = document.getElementById("phone-checking");
                    
                    phoneChecking.style.display = "block";
                    phoneError.style.display = "none";
                    
                    debouncedCheckPhone(phone, function(result) {
                        phoneChecking.style.display = "none";
                        if (result.error) {
                            phoneError.textContent = "Error checking phone number.";
                            phoneError.style.display = "block";
                        } else if (!result.available) {
                            phoneError.textContent = "This phone number is already in use.";
                            phoneError.style.display = "block";
                        } else {
                            phoneError.style.display = "none";
                        }
                    });
                });
            }
        });

        function validateName() {
            let firstName = document.getElementById("first_name").value.trim();
            let lastName = document.getElementById("last_name").value.trim();
            let nameError = document.getElementById("name-error");

            if (!firstName || !lastName) {
                nameError.textContent = "Please enter both first and last name.";
                nameError.style.display = "block";
            } else {
                nameError.style.display = "none";
                nextStep(1);
            }
        }
    </script>
</body>
</html>
