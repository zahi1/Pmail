<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pmail - Register</title>
    <link rel="icon" type="image/png" href="../public/images/Pmail1.png" />
    <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>

    <div class="register-container">
        <img src="/public/images/Pmail1.png" alt="Pmail Logo">
        <h2>Create a Pmail Account</h2>

        <!-- Hidden input for role selection -->
        <input type="hidden" id="role">

        <!-- Step 1: Name -->
        <div id="step-1" class="form-step">
            <input type="text" id="first_name" placeholder="First name" required>
            <input type="text" id="last_name" placeholder="Last name" required>
            <p id="name-error" class="error-message" style="display: none; color: red;">
              Please enter both first and last name.
            </p>
            <button onclick="validateName()">Next</button>
        </div>

        <!-- Step 2: Birthdate Validation -->
        <div id="step-2" class="form-step" style="display: none;">
            <label>Birthdate:</label>
            <input type="date" id="birthdate" required>
            <p id="age-error" class="error-message" style="display: none; color: red;">
              You must be at least 13 years old to register.
            </p>
            <button onclick="validateBirthdate()">Next</button>
        </div>

        <!-- Step 3: Choose Email -->
        <div id="step-3" class="form-step" style="display: none;">
            <h3>Choose your Pmail address</h3>
            <p>Pick a Pmail address or create your own:</p>
            
            <input type="radio" id="email_option1" name="email_option" value="user123@pmail.com">
            <label for="email_option1">user123@pmail.com</label><br>
            
            <input type="radio" id="email_option2" name="email_option" value="jobseeker@pmail.com">
            <label for="email_option2">jobseeker@pmail.com</label><br>
            
            <input type="radio" id="custom_email_option" name="email_option" onclick="enableCustomEmail()">
            <input type="email" id="email_input" placeholder="Create your own Pmail address" disabled required>
        
            <p id="email-error" class="error-message" style="display: none; color: red;">
              Email must end with @pmail.com.
            </p>
            <button onclick="validateEmail()">Next</button>
        </div>

        <!-- Step 4: Password Setup -->
        <div id="step-4" class="form-step" style="display: none;">
            <input type="password" id="password" placeholder="Password" required>
            <input type="password" id="confirm_password" placeholder="Confirm Password" required>
            <input type="checkbox" onclick="togglePassword()"> Show Password
            <p id="password-error" class="error-message" style="display: none; color: red;">
              Passwords do not match.
            </p>
            <button onclick="validatePassword()">Next</button>
        </div>

        <!-- Step 5: Phone Number & Final Sign Up -->
        <div id="step-5" class="form-step" style="display: none;">
            <input type="tel" id="phone" placeholder="Phone Number" required>
            <p id="phone-error" class="error-message" style="display: none; color: red;">
              Please enter a valid phone number.
            </p>
            
            <!-- Categories field - for employees only -->
            <div class="form-group employee-field" id="categories-group" style="display:none;">
              <label>Job Categories of Interest</label>
              <div class="categories-container" id="registration-categories-container">
                <div class="category-item" data-value="Arts">Arts</div>
                <div class="category-item" data-value="Business">Business</div>
                <div class="category-item" data-value="Communications">Communications</div>
                <div class="category-item" data-value="Education">Education</div>
                <div class="category-item" data-value="Healthcare">Healthcare</div>
                <div class="category-item" data-value="Hospitality">Hospitality</div>
                <div class="category-item" data-value="Information Technology">Information Technology</div>
                <div class="category-item" data-value="Law Enforcement">Law Enforcement</div>
                <div class="category-item" data-value="Sales and Marketing">Sales and Marketing</div>
                <div class="category-item" data-value="Science">Science</div>
                <div class="category-item" data-value="Transportation">Transportation</div>
              </div>
              <input type="hidden" id="user_categories" name="user_categories" />
              <p id="categories-error" class="error-message" style="display: none; color: red;">
                Please select at least one category.
              </p>
            </div>
            
            <!-- The external JS (auth.js) will handle the click event for register-btn -->
            <button type="button" id="register-btn" onclick="validateFinal()">Sign Up</button>
        </div>
    </div>

    <!-- External script for login & register calls -->
    <script src="/public/js/auth.js"></script>

    <!-- Inline script for multi-step logic ONLY -->
    <script>
        // 1) On page load, check the URL for a valid role (employee/employer)
        function getRoleFromURL() {
            const params = new URLSearchParams(window.location.search);
            let role = params.get("role");
            if (!role || (role !== "employee" && role !== "employer")) {
                alert("Invalid role. Redirecting...");
                window.location.href = "login.html"; 
            }
            document.getElementById("role").value = role;
        }
        document.addEventListener("DOMContentLoaded", getRoleFromURL);

        // 2) nextStep: hides the current step, shows the next
        function nextStep(step) {
            document.getElementById("step-" + step).style.display = "none";
            document.getElementById("step-" + (step + 1)).style.display = "block";
        }

        // 3) Enable custom email input if user selects that radio
        function enableCustomEmail() {
            document.getElementById("email_input").disabled = false;
        }

        // 4) Toggle password fields from type=password to text
        function togglePassword() {
            let password = document.getElementById("password");
            let confirmPassword = document.getElementById("confirm_password");
            password.type = (password.type === "password") ? "text" : "password";
            confirmPassword.type = (confirmPassword.type === "password") ? "text" : "password";
        }

        // 5) Validate birthdate (13+ years old)
        function validateBirthdate() {
            let birthdate = document.getElementById("birthdate").value;
            if (!birthdate) {
                document.getElementById("age-error").textContent = "Please enter your birthdate.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            let birthDateObj = new Date(birthdate);
            let today = new Date();
            
            // Calculate age
            let age = today.getFullYear() - birthDateObj.getFullYear();
            let monthDiff = today.getMonth() - birthDateObj.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDateObj.getDate())) {
                age--;
            }
            
            // Check minimum age (13)
            if (age < 13) {
                document.getElementById("age-error").textContent = "You must be at least 13 years old to register.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            // Check maximum age (122)
            if (age > 122) {
                document.getElementById("age-error").textContent = "Maximum age cannot exceed 122 years.";
                document.getElementById("age-error").style.display = "block";
                return;
            }
            
            document.getElementById("age-error").style.display = "none";
            nextStep(2);
        }

        // 6) Validate email radio choice or custom input
        function validateEmail() {
            let selectedEmailOption = document.querySelector('input[name="email_option"]:checked');
            let customEmailInput   = document.getElementById("email_input");
            let emailError         = document.getElementById("email-error");
            
            let email = "";

            // If user picked a standard radio option (not custom)
            if (selectedEmailOption && selectedEmailOption.id !== "custom_email_option") {
                email = selectedEmailOption.value;
            }
            // Else if user typed a custom email
            else if (customEmailInput && !customEmailInput.disabled) {
                email = customEmailInput.value.trim();
            }

            // Must end with @pmail.com
            let emailPattern = /^[a-zA-Z0-9._%+-]+@pmail\.com$/;

            if (email === "") {
                emailError.textContent = "Please select or enter a Pmail address.";
                emailError.style.display = "block";
            } else if (!emailPattern.test(email)) {
                emailError.textContent = "Email must end with @pmail.com.";
                emailError.style.display = "block";
            } else {
                emailError.style.display = "none";
                nextStep(3);
            }
        }

        // 7) Validate password match
        function validatePassword() {
            let password        = document.getElementById("password").value;
            let confirmPassword = document.getElementById("confirm_password").value;
            let passwordError   = document.getElementById("password-error");

            // Check for password match
            if (password !== confirmPassword) {
                passwordError.textContent = "Passwords do not match.";
                passwordError.style.display = "block";
                return;
            }
            
            // Check for minimum length
            if (password.length < 8) {
                passwordError.textContent = "Password must be at least 8 characters long.";
                passwordError.style.display = "block";
                return;
            }
            
            // Check for uppercase letter
            if (!/[A-Z]/.test(password)) {
                passwordError.textContent = "Password must include at least one uppercase letter.";
                passwordError.style.display = "block";
                return;
            }
            
            // Check for special character
            if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                passwordError.textContent = "Password must include at least one special character.";
                passwordError.style.display = "block";
                return;
            }

            passwordError.style.display = "none";
            nextStep(4);
        }
        
        // Final validation before registration (Step 5)
        function validateFinal() {
            let phone = document.getElementById("phone").value.trim();
            let phoneError = document.getElementById("phone-error");
            let role = document.getElementById("role").value;
            
            // Validate phone number
            let phonePattern = /^[0-9()+\-\s]{7,20}$/;
            if (!phone) {
                phoneError.textContent = "Please enter your phone number.";
                phoneError.style.display = "block";
                return;
            } else if (!phonePattern.test(phone)) {
                phoneError.textContent = "Please enter a valid phone number.";
                phoneError.style.display = "block";
                return;
            } else {
                phoneError.style.display = "none";
            }
            
            // For employees, validate categories
            if (role === "employee") {
                let categories = document.getElementById("user_categories").value;
                let categoriesError = document.getElementById("categories-error");
                
                if (!categories) {
                    categoriesError.textContent = "Please select at least one category.";
                    categoriesError.style.display = "block";
                    return;
                } else {
                    categoriesError.style.display = "none";
                }
            }
            
            // If all validations pass, call the register function
            register();
        }

        // New validation for first and last name (Step 1)
        function validateName() {
            let firstName = document.getElementById("first_name").value.trim();
            let lastName = document.getElementById("last_name").value.trim();
            let nameError = document.getElementById("name-error");

            if (!firstName || !lastName) {
                nameError.textContent = "Please enter both first and last name.";
                nameError.style.display = "block";
            } else {
                nameError.style.display = "none";
                nextStep(1);
            }
        }
    </script>
</body>
</html>
